# Integrating Supertokens with NextJS 13

## Objective
The objective of this video is to showcase how to integrate Supertokens front end with NextJS 13 by adapting the existing integration steps as shown in the Supertokens documentation.

There are several *critical* steps that must be changed from the existing NextJS 12 integration steps
to accomodate the new NextJS 13 spec.
This will require re-assesing how certain functions are named and placed, and potentailly even changing some implementation details.  This video will serve as a strong guide to fill in this growing space.

## Tone
Medium technical difficulty, tutorial style, informative.

## Outline
- Intro (1-3 minutes)
    - Brief overview of Supertokens
    - Introduction to the value of integrating Supertokens with NextJS 13
- Installation and configuration (2-4 minutes)
    - Install the Supertokens package
    - Create configuration files
- Create frontend and backend config functions (2-4 minutes)
    - Create the frontend config function
    - Create the backend config function
- Call frontend init functions and wrap with SuperTokensWrapper component (2-4 minutes)
    - Replacing the `_app.tsx` file
    - Call the frontend init functions
    - Wrap the functions with `<SuperTokensWrapper>` component
- Outro (1-2 minutes)
    - Recap of the integration steps
    - Encouragement to explore Supertokens further

## Target Audience
The target audience for this video is web developers, particularly those using NextJS 13 and interested in integrating Supertokens into their web applications.

This video is intended to be Supertokens-specific, and can be placed on the website due to the extremely high search volume for NextJS 13 specifically.  


## Notes
```
npx create-next-app@latest
```
install supertokens packages:
```
npm install supertokens-node supertokens-auth-react supertokens-web-js nextjs-cors
```
create files needed:
```
mkdir config && touch config/{appInfo.ts,backendConfig.ts,frontendConfig.ts}
```
add in this to `appInfo.ts`:
```typescript
export const appInfo = {
  // learn more about this on https://supertokens.com/docs/thirdpartyemailpassword/appinfo
  appName: "st-next",
  apiDomain: "http://localhost:3000",
  websiteDomain: "http://localhost:3000",
  apiBasePath: "/api/auth",
  websiteBasePath: "/auth"
}
```
add in this to `frontendConfig.ts`:
```typescript
import ThirdPartyEmailPasswordReact from 'supertokens-auth-react/recipe/thirdpartyemailpassword'
import SessionReact from 'supertokens-auth-react/recipe/session'
import { appInfo } from './appInfo'
import Router from 'next/router'

export const frontendConfig = () => {
  return {
    appInfo,
    recipeList: [
      ThirdPartyEmailPasswordReact.init({
        signInAndUpFeature: {
          providers: [
            ThirdPartyEmailPasswordReact.Google.init(),
          ],
        },
      }),
      SessionReact.init(),
    ],
    windowHandler: (oI: any) => {
      return {
        ...oI,
        location: {
          ...oI.location,
          setHref: (href: string) => {
            window.location.href = href; // use this logic to accomodate server & client components
          },
        },
      }
    },
  }
}
```
add in this to `backendConfig.ts`:
```typescript
import ThirdPartyEmailPasswordNode from 'supertokens-node/recipe/thirdpartyemailpassword'
import SessionNode from 'supertokens-node/recipe/session'
import { appInfo } from './appInfo'
import { TypeInput } from "supertokens-node/types";

export const backendConfig = (): TypeInput => {
  return {
    framework: "express",
    supertokens: {
      // These are the connection details of the app you created on supertokens.com
      connectionURI: "",
      apiKey: "",
    },
    appInfo,
    recipeList: [
      ThirdPartyEmailPasswordNode.init({
        providers: [
          ThirdPartyEmailPasswordNode.Google({
            clientId: "",
            clientSecret: ""
          }),
        ],
      }),
      SessionNode.init(),
    ],
    isInServerlessEnv: true,
  }
}
```
add this to the root layout inside of the app directory:
```typescript
import './globals.css'
import React from 'react'
import { AppProps } from 'next/app'
import SuperTokensReact, { SuperTokensWrapper } from 'supertokens-auth-react'
import { frontendConfig } from '../config/frontendConfig'

export const metadata = {
  title: 'Create Next App',
  description: 'Generated by create next app',
}

if (typeof window !== 'undefined') {
  // we only want to call this init function on the frontend, so we check typeof window !== 'undefined'
  SuperTokensReact.init(frontendConfig())
}

function RootLayout({ children }: {
  children: React.ReactNode
}) {
  return (
    <SuperTokensWrapper>
      {children}
    </SuperTokensWrapper>
  );
}

export default RootLayout
```

We must add this as well to `_app.tsx` which lives in the `/pages` directory.:
```typescript
import React from 'react'
import { AppProps } from 'next/app'
import SuperTokensReact, { SuperTokensWrapper } from 'supertokens-auth-react'

import { frontendConfig } from '../config/frontendConfig'

if (typeof window !== 'undefined') {
  // we only want to call this init function on the frontend, so we check typeof window !== 'undefined'
  SuperTokensReact.init(frontendConfig())
}

function MyApp({ Component, pageProps }: AppProps) {
  return (
    <SuperTokensWrapper>
      <Component {...pageProps} />
    </SuperTokensWrapper>
  );
}

export default MyApp
```

Create a new wildcard page for showing the login UI.
```
touch pages/auth/[[...path]].tsx
```
create the component:
```typescript
import React, { useEffect } from 'react'
import dynamic from 'next/dynamic'
import SuperTokens from 'supertokens-auth-react'
import { redirectToAuth } from 'supertokens-auth-react'

const SuperTokensComponentNoSSR = dynamic<React.ComponentProps<typeof SuperTokens.getRoutingComponent>>(
  new Promise((res) => res(SuperTokens.getRoutingComponent)),
  { ssr: false }
)

export default function Auth() {

  // if the user visits a page that is not handled by us (like /auth/random), then we redirect them back to the auth page.
  useEffect(() => {
    if (SuperTokens.canHandleRoute() === false) {
      redirectToAuth()
    }
  }, [])

  return (
      <SuperTokensComponentNoSSR />
  )
}
```
you should now see a login UI when you visit `/auth`


we now need to add in the correct API routes for NextJS to call upon:
```
touch pages/api/auth/[[...path]].tsx
```
create the API routes needed in this router:
```typescript
import { superTokensNextWrapper } from 'supertokens-node/nextjs'
import { middleware } from 'supertokens-node/framework/express'
import { NextApiRequest, NextApiResponse } from 'next'
import { Request, Response } from 'express';
import supertokens from 'supertokens-node'
import { backendConfig } from '../../../config/backendConfig'
import NextCors from "nextjs-cors";

supertokens.init(backendConfig())

export default async function superTokens(
  req: NextApiRequest & Request,
  res: NextApiResponse & Response
) {

  // NOTE: We need CORS only if we are querying the APIs from a different origin
  await NextCors(req, res, {
    methods: ["GET", "HEAD", "PUT", "PATCH", "POST", "DELETE"],
    origin: "http://localhost:3000",
    credentials: true,
    allowedHeaders: ["content-type", ...supertokens.getAllCORSHeaders()],
  });

  await superTokensNextWrapper(
    async (next) => {
      // This is needed for production deployments with Vercel
      res.setHeader(
          "Cache-Control",
          "no-cache, no-store, max-age=0, must-revalidate"
      );
      await middleware()(req, res, next)
    },
    req,
    res
  )
  if (!res.writableEnded) {
    res.status(404).send('Not found')
  }
}
```
protect another route:
```
touch app/home/page.tsx
```
inside of the home page:
```typescript
import React from 'react'
import dynamic from 'next/dynamic'
import { SessionAuth } from 'supertokens-auth-react/recipe/session'
import ProtectedPage from "./protectedPage";

export default function Home() {
  return (
    // we protect ProtectedPage by wrapping it with SessionAuth

    <SessionAuth>
      <ProtectedPage />
    </SessionAuth>
  )
}
```